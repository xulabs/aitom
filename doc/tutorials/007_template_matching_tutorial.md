# Template Matching Tutorial
In this tutorial, an example run of template matching using AITom is shown in 007_template_matching.py. This tutorial uses actin filament template matching in lamellipodia as an example. With appropriate templates and adjustments to parameters, the same approach can be applied to the analysis of other cellular structures as well. For a description of template matching, see section 3.2.1 of by Zeng and Xu (2019). The demo data can be downloaded from https://cmu.app.box.com/s/e1jed7sionza8uehzzy59lcyzmmbhdp8.

## Map
The lamellipodia tomogram data used in this tutorial were originally published by Vinzenz et al. (2012). The dataset was downloaded from https://cellix.imba.oeaw.ac.at/lamellipodia/et. demo_map.rec is a subtomogram sliced from the dataset above.

## Template
The template used in this tutorial, demo_template.rec, is an cylindrical actin filament segment sliced from the lamellipodia tomogram. Rigort et al. (2012) described their template used for actin filament template matching as a cylinder with a length of 42nm. demo_template.rec roughly fits this description, but the template can be improved by denoising and averaging multiple filament segments.

## Input
007_template_matching.py contains the following input values in main():  
- id - id of the current job  
- out_dir - output directory  
- template - filepath of the template (a mrc or rec file)  
- mode - "convolve" or "normalized-cor"   
- angles - generated by generate_all_rotation_angles(increment), an array of ZYZ Euler angle tuples (phi, theta, psi) for the template to be rotated, in radian
- map_file - filepath to the subtomogram to be analized (a mrc or rec file)  
- stat_out - name or filepath of the output file generated with pickle.dump()  
- increment - the angular increment (in radian) for the template to be rotated in the ZYZ convention

Note that AITom uses the ZYZ representation of Euler angles for template rotations. Each (phi, theta, psi) 3-tuple represents a template orientation that is rotated from the original template using ZYZ rotation:
- phi: rotation angle about the z axis
- theta: rotation angle about the y axis
- psi: rotation angle about the z axis

The generate_all_rotation_angles(increment) function generates all the ZYZ rotation angle combinations for the template from a user-specified increment value. The tutorial uses an increment value of 1/6 π for phi, theta, and psi, giving 12 rotations along each axis and 1728 template orientations in total. 007_template_matching.py contains example input values and can be modified by the user. Parameters to be modified are marked with \#TODO comments. The file paths should be change accordingly.

## Tutorial Outline
1. Modify the input parameters marked by the \#TODO comments in 007_template_matching.py. For a description of the input parameters, see the Input section.
2. Run 007_template_matching.py:  
python3 \<filepath\>/template_matching_demo.py  
Within 007_template_matching.py, the steps for template matching are:
  * load the template (demo_template.rec) and the map (demo_map.rec)
  * preprocess the template (see code, can be customized)
  * template rotations
  * calculate cross-correlation
  * obtain the correlation matrix (c_max) and the orientation matrices (phi_max, theta_max, psi_max)

3. In the user-specified output directory, the output files are generated as:
  * id-c.npy
  * id-phi.npy
  * id-psi.npy
  * id-theta.npy  

id-c.npy is the correlation matrix. id-phi.npy, id-psi.npy, id-theta.npy are the orientation matrices. For further analysis, the .npy files can be read with the numpy.load() function. 

## References

Rigort, A., Günther, D., Hegerl, R., Baum, D., Weber, B., Prohaska, S., Medalia, O., Baumeister, W., & Hege, H. C. (2012). Automated segmentation of electron tomograms for a quantitative description of actin filament networks. Journal of structural biology, 177(1), 135–144. https://doi.org/10.1016/j.jsb.2011.08.012

Vinzenz, M., Nemethova, M., Schur, F., Mueller, J., Narita, A., Urban, E., Winkler, C., Schmeiser, C., Koestler, S. A., Rottner, K., Resch, G. P., Maeda, Y., & Small, J. V. (2012). Actin branching in the initiation and maintenance of lamellipodia. Journal of cell science, 125(Pt 11), 2775–2785. https://doi.org/10.1242/jcs.107623

Zeng, X., & Xu, M. (2019). AITom: Open-source AI platform for cryo-electron tomography data analysis. arXiv:1911.03044 
